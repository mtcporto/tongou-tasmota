<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle e Status do Disjuntor</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  :root {
    --primary: #3498db;
    --success: #2ecc71;
    --danger: #e74c3c;
    --warning: #f39c12;
    --light: #f8f9fa;
    --dark: #343a40;
    --gray: #6c757d;
    --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
    --transition: all 0.3s ease;
  }
  
  body { 
    font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
    background: #f4f4f8; 
    padding: 0;
    margin: 0;
    color: var(--dark);
    line-height: 1.6;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  header {
    background: white;
    padding: 15px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 30px;
  }
  
  header .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  h1 {
    margin: 0;
    color: var(--dark);
    font-size: 1.8rem;
  }
  
  .dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .card {
    background: white;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
    padding: 20px;
    transition: var(--transition);
  }
  
  .card:hover {
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
  }
  
  .card-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  
  .card-header i {
    font-size: 1.5rem;
    margin-right: 10px;
    color: var(--primary);
  }
  
  .card-header h2 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    flex-grow: 1;
  }
  
  .card-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
  }
  
  .data-item {
    padding: 8px;
    border-radius: 8px;
    background: rgba(240, 242, 245, 0.7);
  }
  
  .data-label {
    color: var(--gray);
    font-size: 0.85rem;
    margin-bottom: 3px;
    display: flex;
    align-items: center;
  }
  
  .data-label i {
    margin-right: 4px;
    font-size: 0.8rem;
  }
  
  .data-value {
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .data-unit {
    font-size: 0.8rem;
    color: var(--gray);
    margin-left: 3px;
  }
  
  .status-badge {
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
  }
  
  .badge-online {
    background: var(--success);
    color: white;
  }
  
  .badge-offline {
    background: var(--gray);
    color: white;
  }
  
  .badge-warning {
    background: var(--warning);
    color: white;
  }
  
  .badge-on {
    background: var(--success);
    color: white;
  }
  
  .badge-off {
    background: var(--danger);
    color: white;
  }
  
  .controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .btn i {
    margin-right: 8px;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-success {
    background: var(--success);
    color: white;
  }
  
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .info-icon {
    display: inline-block;
    margin-left: 5px;
    width: 16px;
    height: 16px;
    line-height: 16px;
    text-align: center;
    border-radius: 50%;
    background: #e9ecef;
    color: var(--gray);
    font-size: 10px;
    cursor: help;
  }
  
  .device-info {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  
  .device-info-item {
    padding: 6px 12px;
    background: #f8f9fa;
    border-radius: 20px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
  }
  
  .device-info-item i {
    margin-right: 6px;
    color: var(--primary);
    font-size: 0.8rem;
  }
  
  .last-command {
    margin-top: 15px;
    font-size: 0.9rem;
    color: var(--gray);
    font-style: italic;
  }
  
  .collapsible {
    cursor: pointer;
  }
  
  .collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  
  .collapsible-content.expanded {
    max-height: 500px;
  }
  
  .toggle-icon {
    transition: transform 0.3s ease;
  }
  
  .rotate-icon {
    transform: rotate(180deg);
  }
  
  footer {
    background: white;
    padding: 15px 0;
    text-align: center;
    box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
    margin-top: 30px;
  }
  
  footer a {
    color: var(--primary);
    text-decoration: none;
  }
  
  @media (max-width: 768px) {
    .dashboard {
      grid-template-columns: 1fr;
    }
    
    .controls {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
  }
</style>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<header>
  <div class="container">
    <h1><i class="fas fa-bolt"></i> Controle do Disjuntor</h1>
    <div id="connection-status" class="status-badge badge-offline">Desconectado</div>
  </div>
</header>

<div class="container">
  <div class="controls">
    <button id="btnOn" class="btn btn-success"><i class="fas fa-power-off"></i> Ligar</button>
    <button id="btnOff" class="btn btn-danger"><i class="fas fa-power-off"></i> Desligar</button>
    <button id="btnRefresh" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Atualizar Status</button>
  </div>
  
  <p id="lastCommand" class="last-command">Comando enviado: --</p>
  
  <div class="dashboard">
    <!-- Card de Status -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-info-circle"></i>
        <h2>Status Atual</h2>
        <span id="statusBadge" class="status-badge badge-offline">--</span>
      </div>
      <div class="card-body">
        <div class="data-item">
          <div class="data-label"><i class="fas fa-plug"></i> Status</div>
          <div class="data-value"><span id="powerStatus" class="status-badge badge-off">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-signal"></i> Disponibilidade</div>
          <div class="data-value"><span id="availability" class="status-badge badge-offline">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-clock"></i> Último visto</div>
          <div class="data-value"><span id="lastSeen" style="font-size:0.9rem">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-temperature-high"></i> Temperatura</div>
          <div class="data-value"><span id="temp">--</span><span class="data-unit">°C</span></div>
        </div>
      </div>
    </div>
    
    <!-- Card de Energia -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-bolt"></i>
        <h2>Energia</h2>
      </div>
      <div class="card-body">
        <div class="data-item">
          <div class="data-label"><i class="fas fa-tachometer-alt"></i> Tensão</div>
          <div class="data-value"><span id="voltage">--</span><span class="data-unit">V</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-wave-square"></i> Frequência</div>
          <div class="data-value"><span id="freq">--</span><span class="data-unit">Hz</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-exchange-alt"></i> Corrente</div>
          <div class="data-value"><span id="current">--</span><span class="data-unit">A</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-charging-station"></i> Potência Ativa</div>
          <div class="data-value"><span id="activePower">--</span><span class="data-unit">W</span></div>
        </div>
      </div>
    </div>
    
    <!-- Card de Consumo -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-chart-line"></i>
        <h2>Consumo de Energia</h2>
      </div>
      <div class="card-body">
        <div class="data-item">
          <div class="data-label"><i class="fas fa-calendar-day"></i> Hoje</div>
          <div class="data-value"><span id="energyToday">--</span><span class="data-unit">kWh</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-calendar-minus"></i> Ontem</div>
          <div class="data-value"><span id="energyYesterday">--</span><span class="data-unit">kWh</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-history"></i> Total</div>
          <div class="data-value"><span id="energyTotal">--</span><span class="data-unit">kWh</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-percentage"></i> Fator de Potência</div>
          <div class="data-value"><span id="powerFactor">--</span></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Informações detalhadas (expansíveis) -->
  <div class="card">
    <div class="card-header collapsible" id="advanced-toggle">
      <i class="fas fa-server"></i>
      <h2>Informações do Dispositivo</h2>
      <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="collapsible-content" id="advanced-content">
      <div class="card-body" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="data-item">
          <div class="data-label"><i class="fas fa-microchip"></i> Hostname</div>
          <div class="data-value"><span id="hostname">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-wifi"></i> Wi-Fi SSID</div>
          <div class="data-value"><span id="wifiSSID">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-network-wired"></i> MAC</div>
          <div class="data-value"><span id="mac">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-signal"></i> RSSI</div>
          <div class="data-value"><span id="rssi">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-hourglass-half"></i> Uptime</div>
          <div class="data-value"><span id="deviceUptime">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-tag"></i> Nome Amigável</div>
          <div class="data-value"><span id="friendly">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-project-diagram"></i> MQTT Client ID</div>
          <div class="data-value"><span id="mqttClient">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-server"></i> MQTT Broker</div>
          <div class="data-value"><span id="mqttHost">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-globe"></i> IP do dispositivo</div>
          <div class="data-value"><a id="deviceIPLink" href="#" target="_blank">--</a></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-clock"></i> Hora do dispositivo</div>
          <div class="data-value"><span id="deviceTime">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-code"></i> HTTP API</div>
          <div class="data-value"><span id="httpApi">--</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-bolt"></i> Potência Aparente</div>
          <div class="data-value"><span id="apparentPower">--</span><span class="data-unit">VA</span></div>
        </div>
        <div class="data-item">
          <div class="data-label"><i class="fas fa-bolt"></i> Potência Reativa</div>
          <div class="data-value"><span id="reactivePower">--</span><span class="data-unit">VAr</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <a href="http://server.pixelvivo.com.br:18083/" target="_blank"><i class="fas fa-external-link-alt"></i> Painel EMQX</a>
  </div>
</footer>

<script>
const broker = "ws://server.pixelvivo.com.br:8083/mqtt"; // WebSocket MQTT
const client = mqtt.connect(broker, { 
  clientId: "webclient_001",
  username: "disjuntor1",   // seu usuário MQTT
  password: "senha123",     // sua senha MQTT
  keepalive: 30,
  clean: true
});

const topicCmd = "cmnd/hotel/quarto1/disjuntor1/POWER";
const topicState = "tele/hotel/quarto1/disjuntor1/STATE";
const topicSensor = "tele/hotel/quarto1/disjuntor1/SENSOR";
const topicAvailability = "tele/hotel/quarto1/disjuntor1/availability"; // online/offline (retained by device)
const topicLWT = "tele/hotel/quarto1/disjuntor1/LWT"; // LWT padrão do Tasmota
const topicDiscovery = "tasmota/discovery/+/config"; // discovery do Tasmota (pode conter IP)
const topicStat = "stat/hotel/quarto1/disjuntor1/#"; // TODOS os STATUS do Tasmota

// Cache local dos valores
let cache = {
  temp: "--",
  voltage: "--",
  freq: "--",
  current: "--",
  activePower: "--",
  apparentPower: "--",
  reactivePower: "--",
  powerFactor: "--",
  energyToday: "--",
  energyYesterday: "--",
  energyTotal: "--",
  powerStatus: "--"
};

let lastSeen = null;
const HEARTBEAT_TIMEOUT_MS = 70000; // timeout para considerar offline (ajuste conforme heartbeat do device)
let TELE_PERIOD_SEC = 60; // padrão TelePeriod (segundos), será atualizado se STATUS informar outro
let deviceIP = "--";

// Configuração do elemento expansível
document.addEventListener('DOMContentLoaded', function() {
  const advancedToggle = document.getElementById('advanced-toggle');
  const advancedContent = document.getElementById('advanced-content');
  const toggleIcon = document.querySelector('.toggle-icon');
  
  advancedToggle.addEventListener('click', function() {
    advancedContent.classList.toggle('expanded');
    toggleIcon.classList.toggle('rotate-icon');
  });
  
  updateConfirmationBadge();
});

function updateConfirmationBadge(){
  const badge = document.getElementById('statusBadge');
  const availability = document.getElementById('availability').innerText.toLowerCase();
  
  if(availability !== 'online' || !lastSeen){
    badge.innerText = 'Não confirmado';
    badge.className = 'status-badge badge-offline';
    return;
  }
  
  const ageMs = Date.now() - lastSeen;
  if(ageMs <= 2 * TELE_PERIOD_SEC * 1000){
    badge.innerText = 'Confirmado';
    badge.className = 'status-badge badge-online';
  } else if(ageMs <= 10 * TELE_PERIOD_SEC * 1000){
    badge.innerText = 'Possivelmente obsoleto';
    badge.className = 'status-badge badge-warning';
  } else {
    badge.innerText = 'Desatualizado';
    badge.className = 'status-badge badge-offline';
  }
}

// Função para atualizar a interface apenas se houver mudança
function updateDisplay(field, value){
  if(cache[field] !== value){
    cache[field] = value;
    const element = document.getElementById(field);
    if (element) {
      element.innerText = value;
      
      // Atualizações especiais para alguns campos
      if(field === 'powerStatus') {
        if(value.toLowerCase() === 'on') {
          element.className = 'status-badge badge-on';
        } else if(value.toLowerCase() === 'off') {
          element.className = 'status-badge badge-off';
        }
      }
      
      if(field === 'availability') {
        if(value.toLowerCase() === 'online') {
          element.className = 'status-badge badge-online';
          document.getElementById('connection-status').className = 'status-badge badge-online';
          document.getElementById('connection-status').innerText = 'Conectado';
        } else {
          element.className = 'status-badge badge-offline';
          document.getElementById('connection-status').className = 'status-badge badge-offline';
          document.getElementById('connection-status').innerText = 'Desconectado';
        }
      }
    }
  }
}

client.on("connect", () => {
  console.log("Conectado ao EMQX");
  document.getElementById('connection-status').className = 'status-badge badge-online';
  document.getElementById('connection-status').innerText = 'Conectado ao Broker';
  client.subscribe([topicState, topicSensor, topicAvailability]);
  // também subscreve tópico de discovery para capturar IP local (se retido pelo dispositivo)
  client.subscribe(topicDiscovery);
  client.subscribe(topicLWT);
  client.subscribe(topicStat);
});

client.on("message", (topic, message) => {
  const msg = message.toString();
  try {
    const data = JSON.parse(msg);

    if(topic === topicState) {
      updateDisplay("powerStatus", data.POWER || "--");
      // extrair info se disponível
      if(data.Wifi){
        if(data.Wifi.SSId) updateDisplay("wifiSSID", data.Wifi.SSId);
        if(data.Wifi.Signal !== undefined) updateDisplay("rssi", data.Wifi.Signal + " dBm");
      }
      if(data.Time) {
        updateDisplay("deviceUptime", data.Time);
        updateDisplay("deviceTime", data.Time);
        lastSeen = Date.now();
        document.getElementById("lastSeen").innerText = new Date(lastSeen).toLocaleString();
      }
      if(data.Berry && data.Berry.HeapUsed !== undefined) updateDisplay("friendly", "Heap:" + data.Berry.HeapUsed);
      // alguns campos podem vir em discovery
    }

    if(topic === topicSensor) {
      if(data.ANALOG && data.ANALOG.Temperature1 !== undefined)
        updateDisplay("temp", data.ANALOG.Temperature1);

      if(data.ENERGY){
        updateDisplay("voltage", data.ENERGY.Voltage || "--");
        updateDisplay("freq", data.ENERGY.Frequency || "--");
        updateDisplay("current", data.ENERGY.Current || "--");
        updateDisplay("activePower", data.ENERGY.Power || "--");
        updateDisplay("apparentPower", data.ENERGY.ApparentPower || "--");
        updateDisplay("reactivePower", data.ENERGY.ReactivePower || "--");
        updateDisplay("powerFactor", data.ENERGY.Factor || "--");
        updateDisplay("energyToday", data.ENERGY.Today || "--");
        updateDisplay("energyYesterday", data.ENERGY.Yesterday || "--");
        updateDisplay("energyTotal", data.ENERGY.Total || "--");
        if(data.Time){
          updateDisplay("deviceTime", data.Time);
          lastSeen = Date.now();
          document.getElementById("lastSeen").innerText = new Date(lastSeen).toLocaleString();
        }
      }
    }
    
    if(topic === topicAvailability){
      // availability esperado: "online" || "offline" (device deve publicar com retain=true)
      const av = msg.toLowerCase();
      updateDisplay("availability", av);
      if(av === "online"){
        lastSeen = Date.now();
        document.getElementById("lastSeen").innerText = new Date(lastSeen).toLocaleString();
        // opcionalmente indicar visualmente online
        document.getElementById("powerStatus").style.opacity = 1;
        updateConfirmationBadge();
      } else {
        // offline pelo LWT
        document.getElementById("powerStatus").style.opacity = 0.6;
        updateConfirmationBadge();
      }
    }

    if(topic === topicLWT){
      const av = msg.toLowerCase();
      updateDisplay("availability", av);
      if(av === "online" || av === "online\n"){
        lastSeen = Date.now();
        document.getElementById("lastSeen").innerText = new Date(lastSeen).toLocaleString();
        document.getElementById("powerStatus").style.opacity = 1;
        updateConfirmationBadge();
      } else {
        document.getElementById("powerStatus").style.opacity = 0.6;
        updateConfirmationBadge();
      }
    }

    // tratar mensagens stat/..../STATUS* (respostas a STATUS 0/1/2/...)
    if(topic.startsWith("stat/hotel/quarto1/disjuntor1/STATUS")){
      // mensagens de STATUS são JSON com campos StatusNET, StatusMQT, StatusSTS, Status etc.
      try{
        if(data.StatusNET){
          const net = data.StatusNET;
          if(net.Mac) updateDisplay("mac", net.Mac);
          if(net.Hostname) updateDisplay("hostname", net.Hostname);
          if(net.IPAddress){
            deviceIP = net.IPAddress;
            const link = document.getElementById("deviceIPLink");
            link.innerText = deviceIP;
            link.href = `http://${deviceIP}/`;
            // IP shouldn't be stored in deviceUptime
            updateDisplay("deviceUptime", data.Time || "--");
          }
          if(net.HTTP_API !== undefined) updateDisplay("httpApi", net.HTTP_API ? "Enabled" : "Disabled");
        }
        if(data.StatusMQT){
          const m = data.StatusMQT;
          if(m.MqttClient) updateDisplay("mqttClient", m.MqttClient);
          if(m.MqttHost) updateDisplay("mqttHost", m.MqttHost);
        }
        if(data.Status){
          // Status may contain DeviceName / FriendlyName
          const s = data.Status;
          if(s.DeviceName) updateDisplay("friendly", s.DeviceName);
          if(s.FriendlyName && Array.isArray(s.FriendlyName)) updateDisplay("friendly", s.FriendlyName[0]);
        }
        if(data.StatusSTS){
          const sts = data.StatusSTS;
          if(sts.Uptime) updateDisplay("deviceUptime", sts.Uptime);
          if(sts.Wifi && sts.Wifi.Signal !== undefined) updateDisplay("rssi", sts.Wifi.Signal + " dBm");
        }
        // tentar extrair TelePeriod de StatusLOG se presente
        try{
          if(data.StatusLOG && data.StatusLOG.TelePeriod) TELE_PERIOD_SEC = data.StatusLOG.TelePeriod;
        }catch(e){}
        // atualizar lastSeen pois recebemos resposta ativa do device
        lastSeen = Date.now();
        document.getElementById("lastSeen").innerText = new Date(lastSeen).toLocaleString();
        updateDisplay("availability", "online");
        document.getElementById("powerStatus").style.opacity = 1;
        updateConfirmationBadge();
      }catch(e){ /* ignore */ }
    }

    // tentar extrair IP local de discovery ou outros payloads
    if(topic.startsWith("tasmota/discovery/") || topic === topicState || topic === topicSensor){
      // procura por qualquer endereço IPv4 no payload JSON
      try{
        const txt = msg;
        const ipMatch = txt.match(/(25[0-5]|2[0-4]\d|1?\d?\d)(\.(25[0-5]|2[0-4]\d|1?\d?\d)){3}/);
        if(ipMatch){
          deviceIP = ipMatch[0];
          const link = document.getElementById("deviceIPLink");
          link.innerText = deviceIP;
          // usar http por padrão; se quiser https altere aqui
          link.href = `http://${deviceIP}/`;
          updateConfirmationBadge();
        }
        // tentar parsear campos comuns do discovery
        try{
          const obj = JSON.parse(txt);
          if(obj.Name) updateDisplay("friendly", obj.Name);
          if(obj.Hostname) updateDisplay("hostname", obj.Hostname);
          if(obj.Mac) updateDisplay("mac", obj.Mac);
          if(obj.IPAddress) {
            deviceIP = obj.IPAddress;
            const link = document.getElementById("deviceIPLink");
            link.innerText = deviceIP;
            link.href = `http://${deviceIP}/`;
            updateConfirmationBadge();
          }
          if(obj['MQTT Client']) updateDisplay("mqttClient", obj['MQTT Client']);
          if(obj['HTTP API'] !== undefined) updateDisplay("httpApi", obj['HTTP API']);
        }catch(e){ /* não é JSON parseable */ }
      }catch(e){
        // ignore
      }
    }

  } catch(e){
    console.log("Erro ao processar mensagem MQTT:", e);
  }
});

// Botões
document.getElementById("btnOn").addEventListener("click", () => {
  client.publish(topicCmd, "ON");
  document.getElementById("lastCommand").innerText = "Comando enviado: ON";
});

document.getElementById("btnOff").addEventListener("click", () => {
  client.publish(topicCmd, "OFF");
  document.getElementById("lastCommand").innerText = "Comando enviado: OFF";
});

document.getElementById("btnRefresh").addEventListener("click", () => {
  // pede status completo ao device
  client.publish("cmnd/hotel/quarto1/disjuntor1/STATUS", "0");
  document.getElementById("lastCommand").innerText = "Comando enviado: STATUS 0";
});

// Periodic check: se nao temos lastSeen recente, marcar availability offline visualmente
setInterval(() => {
  if(!lastSeen) return;
  if(Date.now() - lastSeen > HEARTBEAT_TIMEOUT_MS){
    updateDisplay("availability", "offline");
    document.getElementById("powerStatus").style.opacity = 0.6;
  }
}, 15000);
// atualizar badge periodicamente para refletir envelhecimento
setInterval(updateConfirmationBadge, 5000);
</script>

</body>
</html>
